<!doctype html>
<html lang="en">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>Finance & Insight Dashboard — Monthly Overview</title>
<style>
  :root{
    --bg:hsl(220 20% 8%);
    --panel:hsl(220 14% 14%);
    --text:#fff;
    --muted:hsl(220 10% 65%);
    --line:hsl(220 10% 35%);
    --accent:hsl(204 90% 55%);
    --radius:14px;
    --header-h:56px;
  }
  *{box-sizing:border-box}
  html,body{height:100%}
  body{
    margin:0;
    font:16px/1.5 system-ui,-apple-system,Segoe UI,Roboto,Helvetica,Arial;
    color:var(--text);
    background:
      radial-gradient(1200px 800px at 80% -10%, hsl(204 70% 15%/.35), transparent 60%),
      radial-gradient(1000px 600px at -20% 110%, hsl(280 60% 20%/.25), transparent 60%),
      var(--bg);
  }
  header{
    position:fixed; inset:0 0 auto 0; height:var(--header-h); z-index:2;
    padding:14px 20px;
    display:flex; align-items:center; justify-content:space-between;
    background:linear-gradient(180deg, hsl(220 14% 12%), hsl(220 16% 10%));
    border-bottom:1px solid hsl(220 10% 20%);
    box-shadow:0 2px 12px hsl(220 30% 2%/.35);
  }
  header h1{margin:0;font-size:clamp(18px,2.4vw,22px);font-weight:600}
  main{padding-top:var(--header-h);}

  .toolbar{
    display:flex; gap:10px; align-items:center;
  }
  .toolbar input{
    width:120px;padding:10px;border:1px solid hsl(220 10% 30%);
    border-radius:10px;background:hsl(220 14% 12%);color:var(--text);outline:0;
  }
  .toolbar input:focus{border-color:var(--accent);box-shadow:0 0 0 3px hsl(204 90% 55%/.15)}
  .toolbar button{
    padding:10px 14px;border:0;border-radius:10px;
    background:linear-gradient(180deg, var(--accent), hsl(204 82% 48%));
    color:#fff;font-weight:600;cursor:pointer;
  }

  .wrap{
    padding:clamp(16px,3vw,28px);
    display:grid;
    grid-template-columns: 1fr;
    gap:20px;
    max-width:1200px;
    margin:0 auto;
  }

  .panel{
    background:linear-gradient(180deg, hsl(220 14% 16%), hsl(220 14% 13%));
    border:1px solid hsl(220 12% 22%);
    border-radius:var(--radius);
    box-shadow:0 20px 60px hsl(220 40% 2%/.6), inset 0 1px 0 hsl(0 0% 100%/.04);
    padding:18px 18px 22px;
  }
  .panel h2{margin:0 0 8px;font-weight:600;font-size:1rem;color:var(--muted)}

  .grid{
    display:grid; grid-template-columns: 1.3fr 1fr; gap:20px;
  }
  @media (max-width: 960px){ .grid{grid-template-columns:1fr} }

  /* table */
  table{width:100%; border-collapse:collapse; font-size:0.95rem}
  thead th{
    text-align:left; padding:10px; color:var(--muted); border-bottom:1px solid var(--line);
    font-weight:600;
  }
  tbody td{padding:8px 10px; border-bottom:1px dashed var(--line);}
  tfoot td{padding:10px; border-top:1px solid var(--line); font-weight:600}
  .num{text-align:right; font-variant-numeric: tabular-nums;}
  .pos{color:hsl(145 70% 60%)}
  .neg{color:hsl(0 70% 60%)}

  /* chart */
  .chart-wrap{position:relative}
  canvas{width:100%; height:360px; display:block}
  .legend{display:flex; gap:12px; align-items:center; font-size:0.9rem; color:var(--muted); margin-top:6px}
  .swatch{width:12px; height:12px; border-radius:3px; display:inline-block}
  .income{background:hsl(145 70% 50%)}
  .expense{background:hsl(0 70% 55%)}
  .net{background:hsl(204 90% 55%)}
  .status{color:var(--muted); font-size:0.9rem; margin-top:6px}
</style>
</head>
<body>
  <header>
    <h1>Finance &amp; Insight Dashboard — Monthly Overview</h1>
    <div class="toolbar" role="region" aria-label="Year selector">
      <input id="year" type="number" min="1900" max="9999" step="1" />
      <button id="loadBtn" type="button">Load</button>
    </div>
  </header>

  <main>
    <div class="wrap">
      <section class="panel">
        <h2>Chart</h2>
        <div class="chart-wrap">
          <canvas id="chart" width="1200" height="360" aria-label="Income vs Expense per month"></canvas>
          <div class="legend">
            <span class="swatch income"></span> Income
            <span class="swatch expense"></span> Expense
            <span class="swatch net"></span> Net
          </div>
          <div class="status" id="status"></div>
        </div>
      </section>

      <section class="panel">
        <h2>Table</h2>
        <div class="grid">
          <div>
            <table id="table">
              <thead>
                <tr><th>Month</th><th class="num">Income</th><th class="num">Expense</th><th class="num">Net</th></tr>
              </thead>
              <tbody></tbody>
              <tfoot>
                <tr><td>Total</td><td class="num" id="tIncome">0.00</td><td class="num" id="tExpense">0.00</td><td class="num" id="tNet">0.00</td></tr>
              </tfoot>
            </table>
          </div>
          <div>
            <p class="status" id="summary"></p>
          </div>
        </div>
      </section>
    </div>
  </main>

<script>
(function(){
  const yearInput = document.getElementById('year');
  const loadBtn = document.getElementById('loadBtn');
  const tableBody = document.querySelector('#table tbody');
  const tIncome = document.getElementById('tIncome');
  const tExpense = document.getElementById('tExpense');
  const tNet = document.getElementById('tNet');
  const summary = document.getElementById('summary');
  const status = document.getElementById('status');
  const canvas = document.getElementById('chart');
  const ctx = canvas.getContext('2d');

  // default year = current year
  const now = new Date();
  yearInput.value = now.getFullYear();

  loadBtn.addEventListener('click', () => loadYear(parseInt(yearInput.value, 10)));
  window.addEventListener('keydown', (e) => {
    if (e.key === 'Enter' && document.activeElement === yearInput) loadYear(parseInt(yearInput.value, 10));
  });

  function fmt(n){ return Number(n).toFixed(2); }

  async function loadYear(year){
    status.textContent = 'Loading…';
    tableBody.innerHTML = '';
    tIncome.textContent = '0.00';
    tExpense.textContent = '0.00';
    tNet.textContent = '0.00';
    summary.textContent = '';

    try{
      const res = await fetch(`/api/monthly-overview?year=${encodeURIComponent(year)}`, {cache:'no-store'});
      if(!res.ok) throw new Error(`HTTP ${res.status}`);
      const json = await res.json();

      const data = normalizeMonths(json.data, year); // ensure all months 01..12 exist
      renderTable(data);
      renderChart(data);
      const totals = totalsFrom(data);
      summary.textContent = `Year ${year}: Income ${fmt(totals.income)}, Expense ${fmt(totals.expense)}, Net ${fmt(totals.net)}.`;
      status.textContent = '';
    }catch(err){
      status.textContent = `Failed to load data: ${err.message}`;
      clearChart();
    }
  }

  function normalizeMonths(rows, year){
    const map = new Map(rows.map(r => [r.month, r]));
    const out = [];
    for(let m=1;m<=12;m++){
      const mm = String(m).padStart(2,'0');
      const key = `${year}-${mm}`;
      const r = map.get(key) || {month:key, income:0, expense:0, net:0};
      r.net = r.income - r.expense;
      out.push(r);
    }
    return out;
  }

  function renderTable(rows){
    let ti=0, te=0, tn=0;
    tableBody.innerHTML = rows.map(r=>{
      ti+=r.income; te+=r.expense; tn+=r.net;
      return `<tr>
        <td>${r.month}</td>
        <td class="num">${fmt(r.income)}</td>
        <td class="num">${fmt(r.expense)}</td>
        <td class="num ${r.net>=0?'pos':'neg'}">${fmt(r.net)}</td>
      </tr>`;
    }).join('');
    tIncome.textContent = fmt(ti);
    tExpense.textContent = fmt(te);
    tNet.textContent = fmt(tn);
  }

  function totalsFrom(rows){
    return rows.reduce((acc,r)=>({
      income: acc.income + r.income,
      expense: acc.expense + r.expense,
      net: acc.net + r.net
    }),{income:0,expense:0,net:0});
  }

  // simple grouped bar chart (Income/Expense) + Net line
  function renderChart(rows){
    clearChart();

    const w = canvas.width, h = canvas.height;
    const padL = 50, padR = 20, padT = 12, padB = 40;
    const plotW = w - padL - padR, plotH = h - padT - padB;

    // scales
    const maxVal = Math.max(1, ...rows.flatMap(r=>[r.income, r.expense, Math.abs(r.net)]));
    const yScale = v => padT + (plotH - (v / maxVal) * plotH);
    const xBand = plotW / rows.length;

    // axes
    ctx.strokeStyle = 'rgba(200,200,220,0.35)';
    ctx.lineWidth = 1;
    ctx.beginPath();
    ctx.moveTo(padL, padT);
    ctx.lineTo(padL, padT + plotH);
    ctx.lineTo(padL + plotW, padT + plotH);
    ctx.stroke();

    // y labels
    ctx.fillStyle = 'rgba(220,220,235,0.7)';
    ctx.font = '12px system-ui';
    for(let i=0;i<=4;i++){
      const v = (maxVal/4)*i;
      const y = yScale(v);
      ctx.fillText(v.toFixed(0), 6, y+4);
      ctx.globalAlpha = 0.15; ctx.beginPath(); ctx.moveTo(padL, y); ctx.lineTo(padL+plotW, y); ctx.stroke(); ctx.globalAlpha = 1;
    }

    // bars
    const barGap = 8;
    const barW = Math.max(4, (xBand - barGap*3)/2);
    rows.forEach((r, i)=>{
      const x0 = padL + i*xBand + barGap;
      // income
      ctx.fillStyle = 'hsl(145 70% 50%)';
      const yI = yScale(r.income);
      ctx.fillRect(x0, yI, barW, padT + plotH - yI);
      // expense
      ctx.fillStyle = 'hsl(0 70% 55%)';
      const x1 = x0 + barW + barGap;
      const yE = yScale(r.expense);
      ctx.fillRect(x1, yE, barW, padT + plotH - yE);
    });

    // net line
    ctx.strokeStyle = 'hsl(204 90% 55%)';
    ctx.lineWidth = 2;
    ctx.beginPath();
    rows.forEach((r,i)=>{
      const x = padL + i*xBand + xBand/2;
      const y = yScale(Math.max(0, r.net));
      if(i===0) ctx.moveTo(x,y); else ctx.lineTo(x,y);
    });
    ctx.stroke();

    // month labels
    ctx.fillStyle = 'rgba(220,220,235,0.8)';
    ctx.font = '12px system-ui';
    rows.forEach((r,i)=>{
      const label = r.month.slice(5); // 'MM'
      const x = padL + i*xBand + xBand/2;
      const y = padT + plotH + 16;
      ctx.textAlign = 'center';
      ctx.fillText(label, x, y);
    });
  }

  function clearChart(){
    ctx.clearRect(0,0,canvas.width,canvas.height);
  }

  // first load
  loadYear(parseInt(yearInput.value, 10));
})();
</script>
</body>
</html>