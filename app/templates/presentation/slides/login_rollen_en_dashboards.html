{% set demo_targets = slide_payload.get('demo_targets', {}) %}
{% set individual_id = demo_targets.get('individual_user_id') if demo_targets else None %}
<article class="slide" data-slide-fragment>
  <header class="slide__header">
    <h2 class="slide__title">Login, rollen en dashboards</h2>
  </header>

  <div class="slide__content slide__grid">
    <div>
      <h3 class="slide__section-title">Aanmeldflow (JWT cookies)</h3>
      <ul class="slide__bullets">
        <li>Het loginformulier zet een JWT in een HttpOnly cookie; niets in localStorage.</li>
        <li>Claims: <code>sub</code>, <code>subject_id</code>, <code>role</code>, <code>roles</code>, <code>party_id</code> en toegestane <code>company_ids</code> voor werknemers.</li>
        <li>De logintoken is een uur geldig; middleware leest de cookie en plaatst de gebruiker op <code>request.state.user</code>.</li>
      </ul>
      <br>

      <h3 class="slide__section-title">Toegang per rol</h3>
      <ul class="slide__bullets">
        <li><strong>Admin:</strong> Ziet alles en landt op het admin dashboard.</li>
        <li><strong>Individueel:</strong> Alleen het eigen dashboard (net worth, accounts, holdings, cashflow).</li>
        <li><strong>Employee:</strong> Krijgt <code>company_ids</code> via employment en <code>CompanyAccessGrant</code> en kan gekoppelde bedrijfsdashboards openen.</li>
        <li>Login redirect naar de juiste landing; ontbrekende rechten geven een 403.</li>
      </ul>
      <br>

      <h3 class="slide__section-title">Dependencies</h3>
      <ul class="slide__bullets">
        <li><code>require_admin_user</code>, <code>require_company_access</code> en <code>require_individual_access</code> blokkeren routes zonder recht.</li>
        <li>Admin overschrijft alle checks; company/individual routes verwachten een matchende <code>party_id</code> of <code>company_id</code> in het token.</li>
      </ul>
    </div>

    <div>
      <h3 class="slide__section-title">Individueel dashboard</h3>
      <p>Elke individuele gebruiker krijgt een gepersonaliseerd dashboard met:</p>
      <ul class="slide__bullets">
        <li><strong>Net worth</strong></li>
        <li><strong>Rekeningen</strong></li>
        <li><strong>Aandelenportfolio</strong></li>
        <li><strong>Inkomsten en uitgaven</strong></li>
      </ul>
      <br>

      <h3 class="slide__section-title">Bedrijfsdashboard</h3>
      <p>Ingelogde gebruikers kunnen ook het dashboard van hun werkgever inzien met deze data:</p>
      <ul class="slide__bullets">
        <li><strong>Rekeningsaldo</strong></li>
        <li><strong>Payrolloverzicht</strong></li>
        <li><strong>Inkomsten en uitgaven</strong></li>
        <li><strong>Winst</strong></li>
      </ul>
    </div>
  </div>

  <div class="auth-diagram" aria-label="Schema authenticatie en autorisatie">
    <div class="auth-diagram__track">
      <div class="auth-diagram__node">
        <p class="auth-diagram__title">Login</p>
        <p class="auth-diagram__body">Form POST → valideer gebruiker</p>
      </div>
      <div class="auth-diagram__arrow">→</div>
      <div class="auth-diagram__node">
        <p class="auth-diagram__title">JWT cookie</p>
        <p class="auth-diagram__body">HttpOnly, short-lived, bevat roles + company_ids</p>
      </div>
      <div class="auth-diagram__arrow">→</div>
      <div class="auth-diagram__node">
        <p class="auth-diagram__title">Dependencies</p>
        <p class="auth-diagram__body"><code>require_admin_user</code>, <code>require_company_access</code>, <code>require_individual_access</code></p>
      </div>
      <div class="auth-diagram__arrow">→</div>
      <div class="auth-diagram__node">
        <p class="auth-diagram__title">Scope</p>
        <p class="auth-diagram__body">Admin: alles • Employee: eigen bedrijf • Individu: eigen dashboards</p>
      </div>
    </div>
  </div>

  <div class="slide__demo" aria-label="Individueel dashboard live voorbeeld">
    <div class="slide__embed">
      {% if individual_id %}
      <iframe
        src="{{ request.url_for('read_individual_dashboard', user_id=individual_id) }}?embed=1"
        title="Individueel dashboard demo"
        loading="lazy"
        aria-label="Individueel dashboard"
      ></iframe>
      {% else %}
      <div class="slide__callout slide__demo-note is-empty">
        <p class="slide__callout-title">Geen demo-gebruiker gevonden</p>
        <p>Controleer seed-data of databaseverbinding; de user_id kon niet worden geladen.</p>
      </div>
      {% endif %}
    </div>
  </div>
</article>
