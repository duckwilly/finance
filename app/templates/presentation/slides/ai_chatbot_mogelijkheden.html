<article class="slide" data-slide-fragment>
  <header class="slide__header">
    <h2 class="slide__title">AI chatbot mogelijkheden</h2>
  </header>
  <div class="slide__content">
    <div style="margin-bottom: 1.5rem;">
      <h3 class="slide__section-title">Hoe het werkt</h3>
      <p>Wanneer een gebruiker een vraag stelt zoals "Toon mijn uitgaven per categorie":</p>
      <ol class="slide__bullets" style="list-style-type: decimal; padding-left: 1.5rem;">
        <li><strong>AI model:</strong> Genereert een plan met welke tools/data nodig zijn
          <ul style="margin-top: 0.25rem; padding-left: 1.25rem; list-style-type: disc;">
            <li>Ondersteunde LLMs: Claude (Anthropic) en GPT (OpenAI)</li>
            <li>Bestand: <code>app/ai_chatbot/llm_providers.py</code></li>
          </ul>
        </li>
        <li><strong>Python tools:</strong> Genereren SQL queries en halen data op uit de database
          <ul style="margin-top: 0.25rem; padding-left: 1.25rem; list-style-type: disc;">
            <li>Analytics functies zoals <code>expenses_by_category()</code>, <code>leaderboard()</code></li>
            <li>Bestand: <code>app/ai_chatbot/tools/analytics.py</code></li>
          </ul>
        </li>
        <li><strong>ChartGenerator:</strong> Python code zet de data om in Chart.js configuraties
          <ul style="margin-top: 0.25rem; padding-left: 1.25rem; list-style-type: disc;">
            <li>Genereert JSON configuraties voor bar, pie, line, doughnut charts</li>
            <li>Bestand: <code>app/ai_chatbot/chart_generator.py</code></li>
          </ul>
        </li>
        <li><strong>Frontend:</strong> Chart.js rendert de configuratie direct in de browser</li>
      </ol>
    </div>

    <div>
      <h3 class="slide__section-title">Live demo</h3>
      <p>Probeer de chatbot hieronder uit om te zien hoe het werkt tijdens de presentatie:</p>
      
      <link rel="stylesheet" href="{{ url_for('static', path='ai_chatbot/chatbot.css') }}" />
      <script src="{{ url_for('static', path='ai_chatbot/chatbot.js') }}" defer></script>
      
      <div style="margin: 1.5rem 0; border: 1px solid var(--presentation-border); border-radius: 12px; overflow: hidden; background: var(--presentation-surface);">
        <div style="display: grid; grid-template-rows: auto 1fr; gap: 0; min-height: 600px;">
          <!-- Response panel (shown when response arrives) -->
          <section id="dashboard-panel" class="details details--ai" data-panel="chatbot" style="display: none; border-bottom: 1px solid var(--presentation-border); max-height: 400px; overflow-y: auto;">
            <div class="details__panel details__panel--focus">
              <div class="chatbot-visuals" aria-live="polite">
                <div class="chart-container" id="chart-container" style="display: none;">
                  <h3 class="chart-title" id="chart-title"></h3>
                  <canvas id="chart-canvas"></canvas>
                </div>

                <div class="table-container" id="table-container" style="display: none;">
                  <table id="data-table">
                    <thead id="table-head"></thead>
                    <tbody id="table-body"></tbody>
                  </table>
                </div>

                <div id="chat-visualizations-panel" class="chat-visualizations"></div>
              </div>
            </div>
          </section>
          
          <!-- Chatbot interface -->
          <aside class="workspace__chat" id="dashboard-chat" aria-label="AI assistant" style="position: relative; width: 100%;">
            <div class="chat-panel" style="height: 100%; border: none; border-radius: 0;">
              <div class="chat-panel__header">
                <div class="chat-panel__header-copy">
                  <p class="eyebrow">AI copilot</p>
                  <h2 class="chat-panel__title">Chat-driven insights</h2>
                  <p class="chat-panel__hint">
                    Ask for spending breakdowns, ad-hoc KPIs or visual slices of the data.
                  </p>
                </div>
              </div>

              <div class="chat-panel__body" id="chat-panel-body">
                <div class="chat-panel__scroll">
                  <div class="chat-messages" id="chat-messages" aria-live="polite">
                    <div class="welcome-message">
                      <p>ðŸ’¬ Ask about your spending, income trends, or any category you want to explore.</p>
                      <p>Charts and tables will automatically appear above when needed.</p>
                    </div>
                  </div>

                  <ul class="chat-quick-actions" aria-label="Suggested prompts">
                    <li>
                      <button type="button" data-chat-suggestion="Show a bar chart of expenses by category for the last 30 days with x_axis=category and y_axis=total, sorted descending, using EUR.">
                        Category spend (30d)
                      </button>
                    </li>
                    <li>
                      <button type="button" data-chat-suggestion="Compare monthly income vs expenses over the last 6 months as a grouped bar chart with x_axis=month and y_axis=[income_total,expenses], sorted ascending by month.">
                        Income vs expenses (6m)
                      </button>
                    </li>
                    <li>
                      <button type="button" data-chat-suggestion="Plot an expense trend line for the last 180 days with x_axis=month and y_axis=total, sorted ascending by month.">
                        Expense trend (180d)
                      </button>
                    </li>
                    <li>
                      <button type="button" data-chat-suggestion="List the top 5 spenders in the last 30 days as a bar chart with x_axis=party_name and y_axis=total, sorted descending.">
                        Top spenders (30d)
                      </button>
                    </li>
                  </ul>

                  <div id="chat-visualizations" class="chat-visualizations"></div>
                </div>

                <div class="chat-input-container">
                  <form
                    id="chat-form"
                    data-chatbot-form
                    hx-post="/chatbot/query/htmx"
                    hx-target="#dashboard-panel"
                    hx-swap="innerHTML"
                    hx-indicator="#loading-indicator"
                  >
                    <input type="hidden" name="response_mode" value="visualization" />
                    <div class="chat-input-row">
                      <label class="chat-model-label" for="model-select">Model</label>
                      <select id="model-select" name="model">
                        <option value="claude-haiku-4-5-20251001">Claude Haiku 4.5</option>
                        <option value="gpt-4o-mini">GPT 4o Mini</option>
                      </select>
                    </div>
                    <div class="chat-input-block">
                      <textarea
                        name="question"
                        id="question-input"
                        class="chat-input-block__textarea"
                        placeholder="Ask for dashboards, charts, or tables"
                        autocomplete="off"
                        rows="2"
                        data-min-height="72"
                        data-max-height="220"
                        required
                      ></textarea>
                      <button type="submit" class="chat-input-block__button" id="send-button">
                        <span>Send</span>
                      </button>
                    </div>
                    <div class="loading-indicator" id="loading-indicator">
                      <div class="spinner"></div>
                      <span>Thinking...</span>
                    </div>
                  </form>
                </div>
                <div id="chatbot-response-target" style="display: none;"></div>
              </div>
            </div>
          </aside>
        </div>
      </div>
      
      <script>
        // Initialize chatbot when slide is loaded
        (function() {
          // Wait for chatbot.js to be available
          const initChatbot = () => {
            if (window.initializeChatbot) {
              window.initializeChatbot();
            } else {
              setTimeout(initChatbot, 100);
            }
          };
          
          if (document.readyState === 'loading') {
            document.addEventListener('DOMContentLoaded', initChatbot);
          } else {
            initChatbot();
          }
          
          // Handle HTMX responses to show the panel
          document.body.addEventListener('htmx:afterSwap', (event) => {
            const panel = document.getElementById('dashboard-panel');
            if (panel && event.detail?.target === panel) {
              panel.style.display = 'block';
              // Scroll panel into view for presentation
              panel.scrollIntoView({ behavior: 'smooth', block: 'nearest' });
              // Trigger chart resize if needed
              setTimeout(() => {
                window.dispatchEvent(new Event('resize'));
              }, 100);
            }
          });
        })();
      </script>
    </div>
  </div>
</article>
