<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <title>Admin dashboard â€¢ Finance</title>
    <link rel="stylesheet" href="{{ url_for('static', path='css/base.css') }}" />
    <link rel="stylesheet" href="{{ url_for('static', path='css/admin.css') }}" />
    <link rel="stylesheet" href="{{ url_for('static', path='ai_chatbot/chatbot.css') }}" />
    <script src="https://unpkg.com/htmx.org@1.9.12" defer></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.4/dist/chart.umd.min.js" defer></script>
    <script src="{{ url_for('static', path='js/theme-switcher.js') }}" defer></script>
    <script src="{{ url_for('static', path='js/admin-charts.js') }}" defer></script>
    <script src="{{ url_for('static', path='js/list-view.js') }}" defer></script>
    <script src="{{ url_for('static', path='ai_chatbot/chatbot.js') }}" defer></script>
  </head>
  <body class="page">
    <header class="page__header">
      <div class="page__headline">
        <p class="eyebrow">Finance platform</p>
        <h1 class="page__title">Admin dashboard</h1>

      </div>
      {% set first_date = metrics.first_transaction_at.date() if metrics.first_transaction_at else 'â€”' %}
      {% set last_date = metrics.last_transaction_at.date() if metrics.last_transaction_at else 'â€”' %}
      <div class="page__meta">
        <div class="badge">Simulated data â€¢ {{ first_date }} to {{ last_date }}</div>
        <button id="theme-toggle" class="theme-toggle" type="button" aria-label="Toggle theme">
          <span class="theme-toggle__icon">ðŸŒ™</span>
          <span class="theme-toggle__label">Dark mode</span>
        </button>
        <a class="logout-link" href="{{ request.url_for('logout') }}">Log out</a>
      </div>
    </header>

    <!-- Floating chatbot button toggles in-place chat workspace -->
    <button
      type="button"
      id="chatbot-toggle"
      class="floating-chatbot-button"
      aria-label="Open AI Chat"
      aria-expanded="false"
      aria-controls="dashboard-chat"
    >
      ðŸ’¬
    </button>

    <main class="page__content">
      <section class="card-grid" role="group" aria-label="Dashboard panels">
        <button
          type="button"
          class="card card--action is-active"
          data-panel-button="individuals"
          hx-get="{{ request.url_for('render_panel', panel_name='individuals') }}"
          hx-target="#dashboard-panel"
          hx-swap="outerHTML"
          aria-pressed="true"
        >
          <span class="card__label">Individuals</span>
          <span class="card__value">{{ '{:,}'.format(metrics.total_individuals) }}</span>
          <span class="card__hint">People we track across the platform.</span>
        </button>
        <button
          type="button"
          class="card card--action"
          data-panel-button="companies"
          hx-get="{{ request.url_for('render_panel', panel_name='companies') }}"
          hx-target="#dashboard-panel"
          hx-swap="outerHTML"
          aria-pressed="false"
        >
          <span class="card__label">Companies</span>
          <span class="card__value">{{ '{:,}'.format(metrics.total_companies) }}</span>
          <span class="card__hint">Businesses on file with us.</span>
        </button>
        <button
          type="button"
          class="card card--action"
          data-panel-button="transactions"
          hx-get="{{ request.url_for('render_panel', panel_name='transactions') }}"
          hx-target="#dashboard-panel"
          hx-swap="outerHTML"
          aria-pressed="false"
        >
          <span class="card__label">Transactions</span>
          <span class="card__value">{{ '{:,}'.format(metrics.total_transactions) }}</span>
          <span class="card__hint">Simulated records to explore.</span>
        </button>
        <button
          type="button"
          class="card card--action"
          data-panel-button="stocks"
          hx-get="{{ request.url_for('render_panel', panel_name='stocks') }}"
          hx-target="#dashboard-panel"
          hx-swap="outerHTML"
          aria-pressed="false"
        >
          <span class="card__label">Assets under management</span>
          <span class="card__value">{{ humanize_currency(metrics.total_aum, short=true, decimals=1) }}</span>
          <span class="card__hint">
            {{ humanize_currency(metrics.total_cash, short=true, decimals=1) }} in cash â€¢
            {{ humanize_currency(metrics.total_holdings, short=true, decimals=1) }} invested
          </span>
        </button>
      </section>

      <section class="workspace" aria-label="Dashboard content and AI assistant" data-workspace>
        <div class="workspace__dashboard" id="dashboard-view">
          {% set chart = panel_chart %}
          {% set chart_type = panel_config.chart_type %}
          {% set list_id = panel_config.list_id %}
          {% set panel_key = panel_name | default('individuals') %}
          {% set view = panel_view %}
          {% include 'admin/partials/panel.html' %}
        </div>

        <aside class="workspace__chat" id="dashboard-chat" aria-label="AI assistant">
          <div class="chat-panel">
            <div class="chat-panel__header">
              <div>
                <p class="eyebrow">AI assistant</p>
                <h2 class="chat-panel__title">Chat-driven insights</h2>
                <p class="chat-panel__hint">Toggle to split the dashboard and keep your chat in view.</p>
              </div>
            </div>
            <div class="chat-panel__body" id="chat-panel-body">
              <div class="chat-messages" id="chat-messages" aria-live="polite">
                <div class="welcome-message">
                  <p>ðŸ’¬ Ask for spending breakdowns, income trends, or specific categories.</p>
                  <p>Charts and tables will replace the dashboard below using HTMX.</p>
                </div>
              </div>

              <div class="chat-input-container">
                <form
                  id="chat-form"
                  hx-post="/chatbot/query/htmx"
                  hx-target="#dashboard-panel"
                  hx-swap="outerHTML"
                  hx-indicator="#loading-indicator"
                >
                  <input type="hidden" name="response_mode" value="visualization" />
                  <div class="chat-input-row">
                    <label class="chat-model-label" for="model-select">Model</label>
                    <select id="model-select" name="model">
                      <option value="ollama:llama3:latest">Llama 3 (charts + data)</option>
                      <option value="ollama:deepseek-r1:8b">DeepSeek R1 8B</option>
                      <option value="ollama:llama3.2:1b">Llama 3.2 1B (chat only)</option>
                      <option value="claude">Claude Sonnet</option>
                      <option value="chatgpt">GPT-4o</option>
                    </select>
                    <input type="hidden" name="model" id="model-input" value="ollama:llama3:latest" />
                  </div>
                  <div class="input-wrapper">
                    <input
                      type="text"
                      name="question"
                      id="question-input"
                      placeholder="Ask for dashboards, charts, or tables"
                      autocomplete="off"
                      required
                    />
                    <button type="submit" class="primary-button">
                      <span>Send</span>
                    </button>
                  </div>
                  <div class="loading-indicator" id="loading-indicator">
                    <div class="spinner"></div>
                    <span>Thinking...</span>
                  </div>
                </form>
              </div>
              <div id="chatbot-response-target" style="display: none;"></div>
            </div>
          </div>
        </aside>
      </section>
    </main>

    <footer class="page__footer">
      <p>Wie dit leest is gek</p>
      <p>Ik ben niet gek >:(</p>
    </footer>

    <script>
      (function () {
        const setActive = (panel) => {
          document.querySelectorAll('[data-panel-button]').forEach((button) => {
            const isActive = button.dataset.panelButton === panel;
            button.classList.toggle('is-active', isActive);
            button.setAttribute('aria-pressed', isActive ? 'true' : 'false');
          });
        };

        document.addEventListener('click', (event) => {
          const button = event.target.closest('[data-panel-button]');
          if (button) {
            setActive(button.dataset.panelButton);
          }
        });

        const workspace = document.querySelector('[data-workspace]');
        const chatToggleButton = document.getElementById('chatbot-toggle');
        const chatForm = document.getElementById('chat-form');

        const updateWorkspaceState = (isOpen) => {
          if (!workspace || !chatToggleButton) return;
          workspace.classList.toggle('workspace--chat-open', isOpen);
          chatToggleButton.setAttribute('aria-expanded', isOpen ? 'true' : 'false');
          chatToggleButton.classList.toggle('is-open', isOpen);
        };

        if (chatToggleButton) {
          chatToggleButton.addEventListener('click', () => {
            const isOpen = !(workspace?.classList.contains('workspace--chat-open'));
            updateWorkspaceState(isOpen);
          });
        }

        if (chatForm) {
          chatForm.addEventListener('submit', () => {
            updateWorkspaceState(true);
          });
        }

        document.body.addEventListener('htmx:afterSwap', (event) => {
          const { panel } = event.target.dataset || {};
          if (panel) {
            setActive(panel);
          }
        });
      })();
    </script>
  </body>
</html>
