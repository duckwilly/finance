<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <title>Admin dashboard ‚Ä¢ Finance</title>
    <link rel="stylesheet" href="{{ url_for('static', path='css/base.css') }}" />
    <link rel="stylesheet" href="{{ url_for('static', path='css/admin.css') }}" />
    <link rel="stylesheet" href="{{ url_for('static', path='ai_chatbot/chatbot.css') }}" />
    <script src="https://unpkg.com/htmx.org@1.9.12" defer></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.4/dist/chart.umd.min.js" defer></script>
    <script src="{{ url_for('static', path='js/theme-switcher.js') }}" defer></script>
    <script src="{{ url_for('static', path='js/admin-charts.js') }}" defer></script>
    <script src="{{ url_for('static', path='js/list-view.js') }}" defer></script>
    <script src="{{ url_for('static', path='ai_chatbot/chatbot.js') }}" defer></script>
  </head>
  <body class="page">
    <header class="page__header">
      <div class="page__headline">
        <p class="eyebrow">Finance platform</p>
        <h1 class="page__title">Admin dashboard</h1>

      </div>
      {% set first_date = metrics.first_transaction_at.date() if metrics.first_transaction_at else '‚Äî' %}
      {% set last_date = metrics.last_transaction_at.date() if metrics.last_transaction_at else '‚Äî' %}
      <div class="page__meta">
        <div class="badge">Simulated data ‚Ä¢ {{ first_date }} to {{ last_date }}</div>
        <button id="theme-toggle" class="theme-toggle" type="button" aria-label="Toggle theme">
          <span class="theme-toggle__icon">üåô</span>
          <span class="theme-toggle__label">Dark mode</span>
        </button>
        <button
          type="button"
          id="chatbot-toggle"
          class="chat-drawer-toggle"
          aria-label="Toggle AI copilot"
          aria-controls="dashboard-chat"
          aria-expanded="false"
        >
          <span class="chat-drawer-toggle__icon">‚ú®</span>
          <span class="chat-drawer-toggle__copy">
            <span class="chat-drawer-toggle__title">AI copilot</span>
          </span>
        </button>
        <a
          class="chat-drawer-toggle"
          href="{{ request.url_for('presentation_home') }}"
          aria-label="Open presentation"
        >
          <span class="chat-drawer-toggle__icon">üóÇÔ∏è</span>
          <span class="chat-drawer-toggle__copy"> 
            <span class="chat-drawer-toggle__title">Presentation</span>
          </span>
        </a>
        <a class="logout-link" href="{{ request.url_for('logout') }}">Log out</a>
      </div>
    </header>

    <main class="page__content">
      <section class="card-grid" role="group" aria-label="Dashboard panels">
        <button
          type="button"
          class="card card--action is-active"
          data-panel-button="individuals"
          hx-get="{{ request.url_for('render_panel', panel_name='individuals') }}"
          hx-target="#dashboard-panel"
          hx-swap="innerHTML"
          aria-pressed="true"
        >
          <span class="card__label">Individuals</span>
          <span class="card__value">{{ '{:,}'.format(metrics.total_individuals) }}</span>
          <span class="card__hint">People we track across the platform.</span>
        </button>
        <button
          type="button"
          class="card card--action"
          data-panel-button="companies"
          hx-get="{{ request.url_for('render_panel', panel_name='companies') }}"
          hx-target="#dashboard-panel"
          hx-swap="innerHTML"
          aria-pressed="false"
        >
          <span class="card__label">Companies</span>
          <span class="card__value">{{ '{:,}'.format(metrics.total_companies) }}</span>
          <span class="card__hint">Businesses on file with us.</span>
        </button>
        <button
          type="button"
          class="card card--action"
          data-panel-button="transactions"
          hx-get="{{ request.url_for('render_panel', panel_name='transactions') }}"
          hx-target="#dashboard-panel"
          hx-swap="innerHTML"
          aria-pressed="false"
        >
          <span class="card__label">Transactions</span>
          <span class="card__value">{{ '{:,}'.format(metrics.total_transactions) }}</span>
          <span class="card__hint">Simulated records to explore.</span>
        </button>
        <button
          type="button"
          class="card card--action"
          data-panel-button="stocks"
          hx-get="{{ request.url_for('render_panel', panel_name='stocks') }}"
          hx-target="#dashboard-panel"
          hx-swap="innerHTML"
          aria-pressed="false"
        >
          <span class="card__label">Assets under management</span>
          <span class="card__value">{{ humanize_currency(metrics.total_aum, short=true, decimals=1) }}</span>
          <span class="card__hint">
            {{ humanize_currency(metrics.total_cash, short=true, decimals=1) }} in cash ‚Ä¢
            {{ humanize_currency(metrics.total_holdings, short=true, decimals=1) }} invested
          </span>
        </button>
      </section>

      <section
        class="workspace"
        aria-label="Dashboard content and AI assistant"
        data-workspace
        data-panel-target="#dashboard-panel"
      >
        <div class="workspace__dashboard" id="dashboard-view">
          {% set chart = panel_chart %}
          {% set chart_type = panel_config.chart_type %}
          {% set list_id = panel_config.list_id %}
          {% set panel_key = panel_name | default('individuals') %}
          {% set view = panel_view %}
          <section class="details" id="dashboard-panel" data-panel="{{ panel_key }}">
            {% include 'admin/partials/panel.html' %}
          </section>
        </div>

        <aside class="workspace__chat" id="dashboard-chat" aria-label="AI assistant">
          <div class="chat-panel">
            <div class="chat-panel__header">
              <div class="chat-panel__header-copy">
                <p class="eyebrow">AI copilot</p>
                <h2 class="chat-panel__title">Chat-driven insights</h2>
                <p class="chat-panel__hint">
                  Ask for spending breakdowns, ad-hoc KPIs or visual slices of the data.
                </p>
              </div>
              <button type="button" class="chat-panel__close" id="chat-close" aria-label="Close AI assistant">
                ‚úï
              </button>
            </div>

            <div class="chat-panel__body" id="chat-panel-body">
              <div class="chat-panel__scroll">
                <div class="chat-messages" id="chat-messages" aria-live="polite">
                  <div class="welcome-message">
                    <p>üí¨ Ask about your spending, income trends, or any category you want to explore.</p>
                    <p>Charts and tables will automatically appear on the left panel when needed.</p>
                  </div>
                </div>

              <ul class="chat-quick-actions" aria-label="Suggested prompts">
                <li>
                  <button type="button" data-chat-suggestion="Show a bar chart of expenses by category for the last 30 days with x_axis=category and y_axis=total, sorted descending, using EUR.">
                    Category spend (30d)
                  </button>
                </li>
                <li>
                  <button type="button" data-chat-suggestion="Compare monthly income vs expenses over the last 6 months as a grouped bar chart with x_axis=month and y_axis=[income_total,expenses], sorted ascending by month.">
                    Income vs expenses (6m)
                  </button>
                </li>
                <li>
                  <button type="button" data-chat-suggestion="Plot an expense trend line for the last 180 days with x_axis=month and y_axis=total, sorted ascending by month.">
                    Expense trend (180d)
                  </button>
                </li>
                <li>
                  <button type="button" data-chat-suggestion="List the top 5 spenders in the last 30 days as a bar chart with x_axis=party_name and y_axis=total, sorted descending.">
                    Top spenders (30d)
                  </button>
                </li>
              </ul>

              <div id="chat-visualizations" class="chat-visualizations"></div>
            </div>

            <div class="chat-input-container">
              <form
                id="chat-form"
                data-chatbot-form
                hx-post="{{ request.scope.get('root_path', '') }}/chatbot/query/htmx"
                hx-target="#dashboard-panel"
                hx-swap="innerHTML"
                hx-indicator="#loading-indicator"
              >
                <input type="hidden" name="response_mode" value="visualization" />
                <div class="chat-input-row">
                  <label class="chat-model-label" for="model-select">Model</label>
                  <select id="model-select" name="model">
                    <option value="claude-haiku-4-5-20251001">Claude Haiku 4.5</option>
                    <option value="gpt-4o-mini">GPT 4o Mini</option>
                  </select>
                </div>
                <div class="chat-input-block">
                  <textarea
                    name="question"
                    id="question-input"
                    class="chat-input-block__textarea"
                    placeholder="Ask for dashboards, charts, or tables"
                    autocomplete="off"
                    rows="2"
                    data-min-height="72"
                    data-max-height="220"
                    required
                  ></textarea>
                  <button type="submit" class="chat-input-block__button" id="send-button">
                    <span>Send</span>
                  </button>
                </div>
                <div class="loading-indicator" id="loading-indicator">
                  <div class="spinner"></div>
                  <span>Thinking...</span>
                </div>
              </form>
            </div>
            <div id="chatbot-response-target" style="display: none;"></div>
          </div>
        </aside>
      </section>
      <div class="chat-scrim" data-chat-scrim aria-hidden="true"></div>
    </main>

    <footer class="page__footer">
      <p><a href="https://github.com/duckwilly/finance">Project on Github</a></p>
    </footer>

    <script>
      (function () {
        const workspace = document.querySelector('[data-workspace]');
        const panelSelector = workspace?.dataset.panelTarget;
        const getPanelContainer = () => {
          if (panelSelector) {
            return document.querySelector(panelSelector);
          }
          return document.getElementById('dashboard-panel');
        };
        let panelContainer = getPanelContainer();
        const chatToggleButton = document.getElementById('chatbot-toggle');
        const chatCloseButton = document.getElementById('chat-close');
        const chatScrim = document.querySelector('[data-chat-scrim]');
        const chatForm = document.querySelector('[data-chatbot-form]');
        const getQuestionInput = () => document.getElementById('question-input');
        const MAX_INPUT_HEIGHT = 180;

        const emitChartResize = () =>
          window.requestAnimationFrame(() => window.dispatchEvent(new Event('resize')));

        workspace?.addEventListener('transitionend', (event) => {
          if (
            event.target === workspace &&
            (event.propertyName === 'grid-template-columns' || event.propertyName === 'width')
          ) {
            emitChartResize();
          }
        });

        const state = {
          activePanel: panelContainer?.dataset.panel || null,
        };

        const autosizeInput = (input) => {
          if (!input) return;
          input.style.height = 'auto';
          const newHeight = Math.min(input.scrollHeight, MAX_INPUT_HEIGHT);
          input.style.height = `${newHeight}px`;
          input.style.overflowY = input.scrollHeight > MAX_INPUT_HEIGHT ? 'auto' : 'hidden';
        };

        const bindAutosize = () => {
          const input = getQuestionInput();
          if (!input || input.dataset.autosizeBound === 'true') return;
          autosizeInput(input);
          input.dataset.autosizeBound = 'true';
          input.addEventListener('input', () => autosizeInput(input));
        };

        bindAutosize();

        const setActive = (panel) => {
          document.querySelectorAll('[data-panel-button]').forEach((button) => {
            const isActive = button.dataset.panelButton === panel;
            button.classList.toggle('is-active', isActive);
            button.setAttribute('aria-pressed', isActive ? 'true' : 'false');
          });
          state.activePanel = panel;
        };

        document.addEventListener('click', (event) => {
          const button = event.target.closest('[data-panel-button]');
          if (button) {
            setActive(button.dataset.panelButton);
          }
        });

        const applyChatState = (isOpen) => {
          workspace?.classList.toggle('workspace--chat-open', isOpen);
          chatToggleButton?.setAttribute('aria-expanded', isOpen ? 'true' : 'false');
          chatToggleButton?.classList.toggle('is-open', isOpen);
          document.body.classList.toggle('chat-open', isOpen);
          emitChartResize();
        };

        const isChatOpen = () => workspace?.classList.contains('workspace--chat-open');
        const closeChat = () => applyChatState(false);

        chatToggleButton?.addEventListener('click', () => {
          if (isChatOpen()) {
            closeChat();
          } else {
            applyChatState(true);
          }
        });
        chatCloseButton?.addEventListener('click', closeChat);
        chatScrim?.addEventListener('click', closeChat);
        chatForm?.addEventListener('submit', () => applyChatState(true));

        window.addEventListener('keydown', (event) => {
          if (event.key === 'Escape' && isChatOpen()) {
            closeChat();
          }
        });

        document.body.addEventListener('htmx:afterSwap', (event) => {
          panelContainer = getPanelContainer();
          const panelContainerEl = panelContainer;
          const triggeredByChat = chatForm && event.detail?.requestConfig?.elt === chatForm;
          const injectedPanelName =
            panelContainerEl?.querySelector('[data-panel-name]')?.dataset.panelName ||
            event.target.dataset?.panel;

          if (panelContainerEl && injectedPanelName && !triggeredByChat) {
            panelContainerEl.dataset.panel = injectedPanelName;
            setActive(injectedPanelName);
          }

          if (triggeredByChat) {
            bindAutosize();
          }

          if (isChatOpen()) {
            applyChatState(true);
          }
          emitChartResize();
        });
      })();
    </script>
  </body>
</html>
