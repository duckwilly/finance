<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <title>Admin dashboard ‚Ä¢ Finance</title>
    <link rel="stylesheet" href="{{ url_for('static', path='css/base.css') }}" />
    <link rel="stylesheet" href="{{ url_for('static', path='css/admin.css') }}" />
    <link rel="stylesheet" href="{{ url_for('static', path='ai_chatbot/chatbot.css') }}" />
    <script src="https://unpkg.com/htmx.org@1.9.12" defer></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.4/dist/chart.umd.min.js" defer></script>
    <script src="{{ url_for('static', path='js/theme-switcher.js') }}" defer></script>
    <script src="{{ url_for('static', path='js/admin-charts.js') }}" defer></script>
    <script src="{{ url_for('static', path='js/list-view.js') }}" defer></script>
    <script src="{{ url_for('static', path='ai_chatbot/chatbot.js') }}" defer></script>
  </head>
  <body class="page">
    <header class="page__header">
      <div class="page__headline">
        <p class="eyebrow">Finance platform</p>
        <h1 class="page__title">Admin dashboard</h1>

      </div>
      {% set first_date = metrics.first_transaction_at.date() if metrics.first_transaction_at else '‚Äî' %}
      {% set last_date = metrics.last_transaction_at.date() if metrics.last_transaction_at else '‚Äî' %}
      <div class="page__meta">
        <div class="badge">Simulated data ‚Ä¢ {{ first_date }} to {{ last_date }}</div>
        <button id="theme-toggle" class="theme-toggle" type="button" aria-label="Toggle theme">
          <span class="theme-toggle__icon">üåô</span>
          <span class="theme-toggle__label">Dark mode</span>
        </button>
        <button
          type="button"
          id="chatbot-toggle"
          class="chat-drawer-toggle"
          aria-label="Toggle AI copilot"
          aria-controls="dashboard-chat"
          aria-expanded="false"
        >
          <span class="chat-drawer-toggle__icon">‚ú®</span>
          <span class="chat-drawer-toggle__copy">
            <span class="chat-drawer-toggle__title">AI copilot</span>
            <span class="chat-drawer-toggle__meta">Insights & charts</span>
          </span>
        </button>
        <a class="logout-link" href="{{ request.url_for('logout') }}">Log out</a>
      </div>
    </header>

    <main class="page__content">
      <section class="card-grid" role="group" aria-label="Dashboard panels">
        <button
          type="button"
          class="card card--action is-active"
          data-panel-button="individuals"
          hx-get="{{ request.url_for('render_panel', panel_name='individuals') }}"
          hx-target="#dashboard-panel"
          hx-swap="innerHTML"
          aria-pressed="true"
        >
          <span class="card__label">Individuals</span>
          <span class="card__value">{{ '{:,}'.format(metrics.total_individuals) }}</span>
          <span class="card__hint">People we track across the platform.</span>
        </button>
        <button
          type="button"
          class="card card--action"
          data-panel-button="companies"
          hx-get="{{ request.url_for('render_panel', panel_name='companies') }}"
          hx-target="#dashboard-panel"
          hx-swap="innerHTML"
          aria-pressed="false"
        >
          <span class="card__label">Companies</span>
          <span class="card__value">{{ '{:,}'.format(metrics.total_companies) }}</span>
          <span class="card__hint">Businesses on file with us.</span>
        </button>
        <button
          type="button"
          class="card card--action"
          data-panel-button="transactions"
          hx-get="{{ request.url_for('render_panel', panel_name='transactions') }}"
          hx-target="#dashboard-panel"
          hx-swap="innerHTML"
          aria-pressed="false"
        >
          <span class="card__label">Transactions</span>
          <span class="card__value">{{ '{:,}'.format(metrics.total_transactions) }}</span>
          <span class="card__hint">Simulated records to explore.</span>
        </button>
        <button
          type="button"
          class="card card--action"
          data-panel-button="stocks"
          hx-get="{{ request.url_for('render_panel', panel_name='stocks') }}"
          hx-target="#dashboard-panel"
          hx-swap="innerHTML"
          aria-pressed="false"
        >
          <span class="card__label">Assets under management</span>
          <span class="card__value">{{ humanize_currency(metrics.total_aum, short=true, decimals=1) }}</span>
          <span class="card__hint">
            {{ humanize_currency(metrics.total_cash, short=true, decimals=1) }} in cash ‚Ä¢
            {{ humanize_currency(metrics.total_holdings, short=true, decimals=1) }} invested
          </span>
        </button>
      </section>

      <section class="workspace" aria-label="Dashboard content and AI assistant" data-workspace>
        <div class="workspace__dashboard" id="dashboard-view">
          {% set chart = panel_chart %}
          {% set chart_type = panel_config.chart_type %}
          {% set list_id = panel_config.list_id %}
          {% set panel_key = panel_name | default('individuals') %}
          {% set view = panel_view %}
          <section class="details" id="dashboard-panel" data-panel="{{ panel_key }}">
            {% include 'admin/partials/panel.html' %}
          </section>
        </div>

        <aside class="workspace__chat" id="dashboard-chat" aria-label="AI assistant">
          <div class="chat-panel">
            <div class="chat-panel__header">
              <div class="chat-panel__header-copy">
                <p class="eyebrow">AI copilot</p>
                <h2 class="chat-panel__title">Chat-driven insights</h2>
                <p class="chat-panel__hint">
                  Ask for spending breakdowns, ad-hoc KPIs or visual slices of the data.
                </p>
              </div>
              <button type="button" class="chat-panel__close" id="chat-close" aria-label="Close AI assistant">
                ‚úï
              </button>
            </div>

            <div class="chat-panel__body" id="chat-panel-body">
              <div class="chat-panel__scroll">
                <div class="chat-messages" id="chat-messages" aria-live="polite">
                  <div class="welcome-message">
                    <p>üí¨ Ask about your spending, income trends, or any category you want to explore.</p>
                    <p>Charts and tables will automatically appear on the left panel when needed.</p>
                  </div>
                </div>

              <ul class="chat-quick-actions" aria-label="Suggested prompts">
                <li>
                  <button type="button" data-chat-suggestion="Show cash flow trend for the last 6 months">
                    Cash flow pulse
                  </button>
                </li>
                <li>
                  <button type="button" data-chat-suggestion="Which companies contributed most to revenue this quarter?">
                    Top revenue drivers
                  </button>
                </li>
                <li>
                  <button type="button" data-chat-suggestion="Break down expenses for individuals by category">
                    Expense mix
                  </button>
                </li>
                <li>
                  <button type="button" data-chat-suggestion="Compare brokerage holdings vs cash for individuals">
                    Cash vs holdings
                  </button>
                </li>
              </ul>

              <div id="chat-visualizations" class="chat-visualizations"></div>
            </div>

            <div class="chat-input-container">
              <form
                id="chat-form"
                hx-post="/chatbot/query/htmx"
                hx-target="#dashboard-panel"
                hx-swap="innerHTML"
                hx-indicator="#loading-indicator"
              >
                <input type="hidden" name="response_mode" value="visualization" />
                <div class="chat-input-row">
                  <label class="chat-model-label" for="model-select">Model</label>
                  <select id="model-select" name="model">
                    <option value="ollama:llama3:latest">Llama 3 (charts + data)</option>
                    <option value="ollama:deepseek-r1:8b">DeepSeek R1 8B</option>
                    <option value="ollama:llama3.2:1b">Llama 3.2 1B (chat only)</option>
                    <option value="claude">Claude Sonnet</option>
                    <option value="chatgpt">GPT-4o</option>
                  </select>
                  <input type="hidden" name="model" id="model-input" value="ollama:llama3:latest" />
                </div>
                <div class="chat-input-block">
                  <textarea
                    name="question"
                    id="question-input"
                    class="chat-input-block__textarea"
                    placeholder="Ask for dashboards, charts, or tables"
                    autocomplete="off"
                    rows="1"
                    required
                  ></textarea>
                  <button type="submit" class="chat-input-block__button" id="send-button">
                    <span>Send</span>
                  </button>
                </div>
                <div class="loading-indicator" id="loading-indicator">
                  <div class="spinner"></div>
                  <span>Thinking...</span>
                </div>
              </form>
            </div>
            <div id="chatbot-response-target" style="display: none;"></div>
          </div>
        </aside>
      </section>
      <div class="chat-scrim" data-chat-scrim aria-hidden="true"></div>
      <div class="chat-warning" data-chat-warning hidden aria-hidden="true">
        <div class="chat-warning__backdrop"></div>
        <div
          class="chat-warning__dialog"
          role="alertdialog"
          aria-modal="true"
          aria-labelledby="chat-warning-title"
          aria-describedby="chat-warning-body"
        >
          <div class="chat-warning__icon" aria-hidden="true">‚ö†Ô∏è</div>
          <div class="chat-warning__body">
            <h3 id="chat-warning-title">Clear AI visualization?</h3>
            <p id="chat-warning-body">
              Closing the AI copilot will remove the generated visualization and restore the dashboard layout.
            </p>
          </div>
          <div class="chat-warning__actions">
            <button type="button" class="chat-warning__cancel" data-chat-warning-cancel>
              Keep open
            </button>
            <button type="button" class="chat-warning__confirm" data-chat-warning-confirm>
              Clear & close
            </button>
          </div>
        </div>
      </div>
    </main>

    <footer class="page__footer">
      <p>Data shown is for informational purposes only and not financial advice. ¬© 2025</p>
    </footer>

    <script>
      (function () {
        const workspace = document.querySelector('[data-workspace]');
        const chatToggleButton = document.getElementById('chatbot-toggle');
        const chatCloseButton = document.getElementById('chat-close');
        const chatScrim = document.querySelector('[data-chat-scrim]');
        const chatForm = document.getElementById('chat-form');
        const warningShell = document.querySelector('[data-chat-warning]');
        const warningConfirm = document.querySelector('[data-chat-warning-confirm]');
        const warningCancel = document.querySelector('[data-chat-warning-cancel]');
        const panelContainer = document.getElementById('dashboard-panel');
        const getQuestionInput = () => document.getElementById('question-input');
        const MAX_INPUT_HEIGHT = 180;

        const emitChartResize = () =>
          window.requestAnimationFrame(() => window.dispatchEvent(new Event('resize')));

        const state = {
          hasChatVisualization: false,
          activePanel: panelContainer?.dataset.panel || 'individuals',
        };

        const autosizeInput = (input) => {
          if (!input) return;
          input.style.height = 'auto';
          const newHeight = Math.min(input.scrollHeight, MAX_INPUT_HEIGHT);
          input.style.height = `${newHeight}px`;
          input.style.overflowY = input.scrollHeight > MAX_INPUT_HEIGHT ? 'auto' : 'hidden';
        };

        const bindAutosize = () => {
          const input = getQuestionInput();
          if (!input) return;
          autosizeInput(input);
          input.addEventListener('input', () => autosizeInput(input));
        };

        bindAutosize();

        const setActive = (panel) => {
          document.querySelectorAll('[data-panel-button]').forEach((button) => {
            const isActive = button.dataset.panelButton === panel;
            button.classList.toggle('is-active', isActive);
            button.setAttribute('aria-pressed', isActive ? 'true' : 'false');
          });
          state.activePanel = panel;
        };

        document.addEventListener('click', (event) => {
          const button = event.target.closest('[data-panel-button]');
          if (button) {
            setActive(button.dataset.panelButton);
            state.hasChatVisualization = false;
          }
        });

        const applyChatState = (isOpen) => {
          workspace?.classList.toggle('workspace--chat-open', isOpen);
          chatToggleButton?.setAttribute('aria-expanded', isOpen ? 'true' : 'false');
          chatToggleButton?.classList.toggle('is-open', isOpen);
          document.body.classList.toggle('chat-open', isOpen);
          emitChartResize();
        };

        const isChatOpen = () => workspace?.classList.contains('workspace--chat-open');

        const restoreActivePanel = () => {
          if (!window.htmx || !state.activePanel) return;
          const targetButton = document.querySelector(`[data-panel-button="${state.activePanel}"]`);
          const url = targetButton?.getAttribute('hx-get');
          if (!url) return;
          window.htmx.ajax('GET', url, '#dashboard-panel');
        };

        const hideWarning = () => {
          warningShell?.classList.remove('is-visible');
          warningShell?.setAttribute('aria-hidden', 'true');
          warningShell?.setAttribute('hidden', '');
          document.body.classList.remove('modal-open');
        };

        const showWarning = (onDecision) => {
          warningShell?.classList.add('is-visible');
          warningShell?.removeAttribute('hidden');
          warningShell?.setAttribute('aria-hidden', 'false');
          document.body.classList.add('modal-open');

          const handleConfirm = () => {
            cleanup();
            onDecision(true);
          };
          const handleCancel = () => {
            cleanup();
            onDecision(false);
          };
          const cleanup = () => {
            warningConfirm?.removeEventListener('click', handleConfirm);
            warningCancel?.removeEventListener('click', handleCancel);
            hideWarning();
          };

          warningConfirm?.addEventListener('click', handleConfirm);
          warningCancel?.addEventListener('click', handleCancel);
        };

        const requestCloseChat = () => {
          const finalizeClose = () => {
            applyChatState(false);
          };

          if (state.hasChatVisualization) {
            showWarning((confirmed) => {
              if (!confirmed) return;
              state.hasChatVisualization = false;
              restoreActivePanel();
              finalizeClose();
            });
            return;
          }

          finalizeClose();
        };

        chatToggleButton?.addEventListener('click', () => {
          if (isChatOpen()) {
            requestCloseChat();
          } else {
            applyChatState(true);
          }
        });
        chatCloseButton?.addEventListener('click', requestCloseChat);
        chatScrim?.addEventListener('click', requestCloseChat);
        chatForm?.addEventListener('submit', () => applyChatState(true));

        window.addEventListener('keydown', (event) => {
          if (event.key === 'Escape' && isChatOpen()) {
            requestCloseChat();
          }
        });

        document.body.addEventListener('htmx:afterSwap', (event) => {
          const panelContainerEl = document.getElementById('dashboard-panel');
          const triggeredByChat = event.detail?.requestConfig?.elt === chatForm;
          const injectedPanelName =
            event.target.dataset?.panel ||
            panelContainerEl?.querySelector('[data-panel-name]')?.dataset.panelName;

          if (panelContainerEl && injectedPanelName && !triggeredByChat) {
            panelContainerEl.dataset.panel = injectedPanelName;
            setActive(injectedPanelName);
          }

          if (triggeredByChat) {
            state.hasChatVisualization = true;
            bindAutosize();
          }

          if (isChatOpen()) {
            applyChatState(true);
          }
          emitChartResize();
        });
      })();
    </script>
  </body>
</html>
