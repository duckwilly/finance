{% extends "admin/base.html" %}

{% block title %}{{ company.name }} · Finance Admin{% endblock %}

{% block head %}
<style>
  .layout {
    display: flex;
    flex-direction: column;
    gap: 1.75rem;
  }

  .breadcrumbs {
    display: inline-flex;
    align-items: center;
    gap: 0.5rem;
    font-size: 0.95rem;
  }

  .breadcrumbs a {
    color: var(--accent-color);
    text-decoration: none;
    font-weight: 600;
  }

  .breadcrumbs a:hover,
  .breadcrumbs a:focus {
    text-decoration: underline;
  }

  .overview {
    display: grid;
    gap: 1.5rem;
    padding: 1.75rem;
  }

  .overview-header {
    display: flex;
    flex-direction: column;
    gap: 1rem;
  }

  @media (min-width: 720px) {
    .overview-header {
      align-items: center;
      flex-direction: row;
      justify-content: space-between;
    }
  }

  .overview h2 {
    margin: 0;
    font-size: 1.6rem;
  }

  .period-meta {
    margin: 0.25rem 0 0;
    color: var(--muted-text);
    font-size: 0.9rem;
  }

  .period-form {
    display: flex;
    align-items: center;
    gap: 0.75rem;
    flex-wrap: wrap;
  }

  .period-form label {
    font-size: 0.85rem;
    font-weight: 600;
    text-transform: uppercase;
    letter-spacing: 0.05em;
    color: var(--muted-text);
  }

  .period-form .field-group {
    display: inline-flex;
    align-items: center;
    gap: 0.5rem;
    flex-wrap: wrap;
  }

  .period-form input[type="date"] {
    border-radius: 0.5rem;
    border: 1px solid rgba(148, 163, 184, 0.5);
    padding: 0.45rem 0.75rem;
    background-color: rgba(15, 23, 42, 0.03);
    font-size: 0.95rem;
    color: inherit;
  }

  .period-form span.separator {
    font-size: 0.85rem;
    color: var(--muted-text);
  }

  .period-form button {
    border: none;
    border-radius: 0.5rem;
    background-color: var(--accent-color);
    color: #ffffff;
    font-weight: 600;
    padding: 0.5rem 1.1rem;
    cursor: pointer;
    transition: background-color 0.2s ease;
  }

  .period-form button:hover,
  .period-form button:focus {
    background-color: #1d4ed8;
    outline: none;
  }

  .metrics {
    display: grid;
    grid-template-columns: repeat(auto-fit, minmax(180px, 1fr));
    gap: 1.25rem;
  }

  .metric {
    display: flex;
    flex-direction: column;
    gap: 0.35rem;
  }

  .metric span {
    font-size: 0.75rem;
    color: var(--muted-text);
    text-transform: uppercase;
    letter-spacing: 0.05em;
  }

  .metric strong {
    font-size: 1.3rem;
  }

  .metric strong.positive {
    color: #0f766e;
  }

  .metric strong.negative {
    color: #b91c1c;
  }

  .grid {
    display: grid;
    gap: 1.75rem;
  }

  @media (min-width: 960px) {
    .grid {
      grid-template-columns: 2fr 1fr;
    }

    .grid .wide {
      grid-column: 1 / -1;
    }
  }

  .chart-card {
    padding: 1.25rem 1.25rem 1.75rem;
  }

  .chart-container {
    position: relative;
    width: 100%;
    min-height: 240px;
  }

  .chart-container canvas {
    width: 100% !important;
    height: 100% !important;
  }

  table {
    width: 100%;
    border-collapse: collapse;
  }

  th,
  td {
    padding: 0.85rem 1rem;
    text-align: left;
    border-bottom: 1px solid rgba(100, 116, 139, 0.15);
  }

  th {
    font-size: 0.85rem;
    color: var(--muted-text);
    text-transform: uppercase;
    letter-spacing: 0.05em;
  }

  tbody tr:last-child td {
    border-bottom: none;
  }

  .card {
    padding: 1.25rem 0;
  }

  .card-header {
    display: flex;
    align-items: baseline;
    justify-content: space-between;
    gap: 1rem;
    padding: 0 1.25rem;
    margin-bottom: 0.5rem;
  }

  .card h3 {
    margin: 0;
    font-size: 1.2rem;
  }

  .badge {
    display: inline-flex;
    align-items: center;
    border-radius: 999px;
    padding: 0.3rem 0.75rem;
    font-size: 0.8rem;
    background: rgba(14, 116, 144, 0.12);
    color: #0f172a;
    font-weight: 600;
    letter-spacing: 0.03em;
  }

  .compact {
    font-size: 0.95rem;
  }

  .compact th,
  .compact td {
    padding: 0.6rem 1rem;
  }

  .employee-link {
    color: var(--accent-color);
    text-decoration: none;
    font-weight: 600;
  }

  .employee-link:hover,
  .employee-link:focus {
    text-decoration: underline;
  }

  .muted {
    color: var(--muted-text);
  }

  .empty {
    padding: 1.25rem;
    color: var(--muted-text);
    font-style: italic;
  }
</style>
<script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.1/dist/chart.umd.min.js" defer></script>
{% endblock %}

{% block content %}
<section class="layout">
  <nav class="breadcrumbs" aria-label="Breadcrumb">
    <a href="/admin/companies">Companies</a>
    <span aria-hidden="true">/</span>
    <span>{{ company.name }}</span>
  </nav>

  <section class="overview card" aria-labelledby="company-heading">
    <div class="overview-header">
      <div>
        <h2 id="company-heading">{{ company.name }}</h2>
        <p class="period-meta">
          Reporting window:
          {{ company.period.start.strftime('%b %d, %Y') }} –
          {{ company.period.end.strftime('%b %d, %Y') }}
        </p>
      </div>
      <form method="get" class="period-form">
        <label for="start-date">Period</label>
        <div class="field-group">
          <input
            type="date"
            id="start-date"
            name="start_date"
            value="{{ company.period.start.isoformat() }}"
          />
          <span class="separator" aria-hidden="true">to</span>
          <input
            type="date"
            id="end-date"
            name="end_date"
            value="{{ company.period.end.isoformat() }}"
          />
        </div>
        <button type="submit">Apply</button>
      </form>
    </div>
    <div class="metrics">
      <div class="metric" aria-label="Total balance">
        <span>Total Balance</span>
        <strong>{{ '{:,.2f}'.format(company.total_balance) }} EUR</strong>
      </div>
      <div class="metric" aria-label="Payroll headcount">
        <span>Payroll Headcount</span>
        <strong>{{ company.payroll_headcount }}</strong>
      </div>
      <div class="metric" aria-label="Income for the selected period">
        <span>Income · {{ company.period.label }}</span>
        <strong>{{ '{:,.2f}'.format(company.income_total) }} EUR</strong>
      </div>
      <div class="metric" aria-label="Expenses for the selected period">
        <span>Expenses · {{ company.period.label }}</span>
        <strong>{{ '{:,.2f}'.format(company.expense_total) }} EUR</strong>
      </div>
      <div class="metric" aria-label="Net cash flow for the selected period">
        <span>Net Cash Flow</span>
        {% set net_class = 'positive' if company.net_cash_flow >= 0 else 'negative' %}
        <strong class="{{ net_class }}">{{ '{:,.2f}'.format(company.net_cash_flow) }} EUR</strong>
      </div>
      <div class="metric" aria-label="Payroll spend for the selected period">
        <span>Payroll Spend</span>
        <strong>{{ '{:,.2f}'.format(company.payroll_total) }} EUR</strong>
      </div>
    </div>
  </section>

  <section class="grid" aria-label="Company data">
    <article class="card chart-card wide" aria-labelledby="income-trend-heading">
      <div class="card-header">
        <h3 id="income-trend-heading">Income Trend</h3>
        <span class="badge">{{ company.period.label }}</span>
      </div>
      {% if company.income_series %}
      <div class="chart-container">
        <canvas
          id="income-chart"
          role="img"
          aria-label="Line chart showing monthly income for the selected period"
        ></canvas>
      </div>
      {% else %}
      <p class="empty">No income activity in the selected window.</p>
      {% endif %}
    </article>
    <article class="card" aria-labelledby="accounts-heading">
      <div class="card-header">
        <h3 id="accounts-heading">Accounts</h3>
        <span class="badge">{{ company.accounts|length }} total</span>
      </div>
      {% if company.accounts %}
      <table>
        <thead>
          <tr>
            <th scope="col">Name</th>
            <th scope="col">Type</th>
            <th scope="col">Balance</th>
          </tr>
        </thead>
        <tbody>
          {% for account in company.accounts %}
          <tr>
            <td>{{ account.name if account.name else 'Account #' ~ account.account_id }}</td>
            <td>{{ account.type|capitalize }}</td>
            <td>{{ '{:,.2f}'.format(account.balance) }} {{ account.currency }}</td>
          </tr>
          {% endfor %}
        </tbody>
      </table>
      {% else %}
      <p class="empty">No accounts are associated with this company.</p>
      {% endif %}
    </article>

    <article class="card" aria-labelledby="cashflow-heading">
      <div class="card-header">
        <h3 id="cashflow-heading">Cash Flow Snapshot</h3>
        <span class="badge">{{ company.period.label }}</span>
      </div>
      <table class="compact">
        <tbody>
          <tr>
            <th scope="row">Income</th>
            <td>{{ '{:,.2f}'.format(company.income_total) }} EUR</td>
          </tr>
          <tr>
            <th scope="row">Expenses</th>
            <td>{{ '{:,.2f}'.format(company.expense_total) }} EUR</td>
          </tr>
          <tr>
            <th scope="row">Net Cash Flow</th>
            {% set net_class = 'positive' if company.net_cash_flow >= 0 else 'negative' %}
            <td class="{{ net_class }}">{{ '{:,.2f}'.format(company.net_cash_flow) }} EUR</td>
          </tr>
        </tbody>
      </table>
    </article>

    <article class="card" aria-labelledby="payroll-heading">
      <div class="card-header">
        <h3 id="payroll-heading">Payroll</h3>
        <span class="badge">{{ '{:,.2f}'.format(company.payroll_total) }} EUR</span>
      </div>
      {% if company.payroll_employees %}
      <table class="compact">
        <thead>
          <tr>
            <th scope="col">Employee</th>
            <th scope="col">Compensation ({{ company.period.label }})</th>
          </tr>
        </thead>
        <tbody>
          {% for employee in company.payroll_employees %}
          <tr>
            <td>
              {% if employee.counterparty_id %}
              <a
                class="employee-link"
                href="/admin/personal/{{ employee.counterparty_id }}"
              >
                {{ employee.name }}
              </a>
              {% else %}
              {{ employee.name }}
              {% endif %}
            </td>
            <td>{{ '{:,.2f}'.format(employee.total_compensation) }} EUR</td>
          </tr>
          {% endfor %}
        </tbody>
      </table>
      {% else %}
      <p class="empty">No payroll transactions matched the selected period.</p>
      {% endif %}
    </article>

    <article class="card" aria-labelledby="expenses-heading">
      <div class="card-header">
        <h3 id="expenses-heading">Top Expense Categories</h3>
        <span class="badge">{{ company.period.label }}</span>
      </div>
      {% if company.top_expense_categories %}
      <table class="compact">
        <thead>
          <tr>
            <th scope="col">Category</th>
            <th scope="col">Spend</th>
          </tr>
        </thead>
        <tbody>
          {% for category in company.top_expense_categories %}
          <tr>
            <td>{{ category.name }}</td>
            <td>{{ '{:,.2f}'.format(category.total_spent) }} EUR</td>
          </tr>
          {% endfor %}
        </tbody>
      </table>
      {% else %}
      <p class="empty">No expense activity in the selected window.</p>
      {% endif %}
    </article>
  </section>
</section>
<script>
  document.addEventListener('DOMContentLoaded', function () {
    const chartElement = document.getElementById('income-chart');
    if (!chartElement || typeof Chart === 'undefined') {
      return;
    }

    const labels = {{ company.income_series | map(attribute='label') | list | tojson }};
    const rawValues = {{ company.income_series | map(attribute='amount') | list | tojson }};
    const values = rawValues.map(function (value) {
      if (value === null || value === undefined) {
        return 0;
      }
      const parsed = Number(value);
      return Number.isNaN(parsed) ? 0 : parsed;
    });

    const currencyFormatter = new Intl.NumberFormat('en-US', {
      style: 'currency',
      currency: 'EUR',
      maximumFractionDigits: 2,
    });

    new Chart(chartElement, {
      type: 'line',
      data: {
        labels: labels,
        datasets: [
          {
            label: 'Income',
            data: values,
            borderColor: '#2563eb',
            backgroundColor: 'rgba(37, 99, 235, 0.15)',
            borderWidth: 2,
            tension: 0.3,
            fill: true,
            pointRadius: 4,
            pointHoverRadius: 5,
          },
        ],
      },
      options: {
        responsive: true,
        maintainAspectRatio: false,
        plugins: {
          legend: {
            display: false,
          },
          tooltip: {
            callbacks: {
              label: function (context) {
                const amount = context.parsed.y ?? 0;
                return currencyFormatter.format(amount);
              },
            },
          },
        },
        scales: {
          y: {
            beginAtZero: true,
            ticks: {
              callback: function (value) {
                return currencyFormatter.format(value);
              },
            },
            grid: {
              color: 'rgba(148, 163, 184, 0.2)',
            },
          },
          x: {
            ticks: {
              maxRotation: 0,
              autoSkip: true,
              maxTicksLimit: 6,
            },
            grid: {
              display: false,
            },
          },
        },
      },
    });
  });
</script>
{% endblock %}
