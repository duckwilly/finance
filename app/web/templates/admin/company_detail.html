{% extends "admin/base.html" %}

{% block title %}{{ company.name }} · Finance Admin{% endblock %}

{% block head %}
<style>
  .layout {
    display: flex;
    flex-direction: column;
    gap: 1.75rem;
  }

  .breadcrumbs {
    display: inline-flex;
    align-items: center;
    gap: 0.5rem;
    font-size: 0.95rem;
  }

  .breadcrumbs a {
    color: var(--accent-color);
    text-decoration: none;
    font-weight: 600;
  }

  .breadcrumbs a:hover,
  .breadcrumbs a:focus {
    text-decoration: underline;
  }

  .overview {
    display: grid;
    gap: 1.5rem;
    padding: 1.75rem;
  }

  .overview-header {
    display: flex;
    flex-direction: column;
    gap: 1rem;
  }

  @media (min-width: 720px) {
    .overview-header {
      align-items: center;
      flex-direction: row;
      justify-content: space-between;
    }
  }

  .overview h2 {
    margin: 0;
    font-size: 1.6rem;
  }

  .period-meta {
    margin: 0.25rem 0 0;
    color: var(--muted-text);
    font-size: 0.9rem;
  }

  .period-form {
    display: flex;
    align-items: center;
    gap: 0.75rem;
  }

  .period-form label {
    font-size: 0.85rem;
    font-weight: 600;
    text-transform: uppercase;
    letter-spacing: 0.05em;
    color: var(--muted-text);
  }

  .period-form select {
    border-radius: 0.5rem;
    border: 1px solid rgba(148, 163, 184, 0.5);
    padding: 0.45rem 0.75rem;
    background-color: rgba(15, 23, 42, 0.03);
    font-size: 0.95rem;
  }

  .metrics {
    display: grid;
    grid-template-columns: repeat(auto-fit, minmax(180px, 1fr));
    gap: 1.25rem;
  }

  .metric {
    display: flex;
    flex-direction: column;
    gap: 0.35rem;
  }

  .metric span {
    font-size: 0.75rem;
    color: var(--muted-text);
    text-transform: uppercase;
    letter-spacing: 0.05em;
  }

  .metric strong {
    font-size: 1.3rem;
  }

  .metric strong.positive {
    color: #0f766e;
  }

  .metric strong.negative {
    color: #b91c1c;
  }

  .grid {
    display: grid;
    gap: 1.75rem;
  }

  @media (min-width: 960px) {
    .grid {
      grid-template-columns: 2fr 1fr;
    }
  }

  table {
    width: 100%;
    border-collapse: collapse;
  }

  th,
  td {
    padding: 0.85rem 1rem;
    text-align: left;
    border-bottom: 1px solid rgba(100, 116, 139, 0.15);
  }

  th {
    font-size: 0.85rem;
    color: var(--muted-text);
    text-transform: uppercase;
    letter-spacing: 0.05em;
  }

  tbody tr:last-child td {
    border-bottom: none;
  }

  .card {
    padding: 1.25rem 0;
  }

  .card-header {
    display: flex;
    align-items: baseline;
    justify-content: space-between;
    gap: 1rem;
    padding: 0 1.25rem;
    margin-bottom: 0.5rem;
  }

  .card h3 {
    margin: 0;
    font-size: 1.2rem;
  }

  .badge {
    display: inline-flex;
    align-items: center;
    border-radius: 999px;
    padding: 0.3rem 0.75rem;
    font-size: 0.8rem;
    background: rgba(14, 116, 144, 0.12);
    color: #0f172a;
    font-weight: 600;
    letter-spacing: 0.03em;
  }

  .compact {
    font-size: 0.95rem;
  }

  .compact th,
  .compact td {
    padding: 0.6rem 1rem;
  }

  .muted {
    color: var(--muted-text);
  }

  .empty {
    padding: 1.25rem;
    color: var(--muted-text);
    font-style: italic;
  }
</style>
{% endblock %}

{% block content %}
<section class="layout">
  <nav class="breadcrumbs" aria-label="Breadcrumb">
    <a href="/admin/companies">Companies</a>
    <span aria-hidden="true">/</span>
    <span>{{ company.name }}</span>
  </nav>

  <section class="overview card" aria-labelledby="company-heading">
    <div class="overview-header">
      <div>
        <h2 id="company-heading">{{ company.name }}</h2>
        <p class="period-meta">
          Reporting window:
          {{ company.period.start.strftime('%b %d, %Y') }} –
          {{ company.period.end.strftime('%b %d, %Y') }}
        </p>
      </div>
      <form method="get" class="period-form">
        <label for="period">Period</label>
        <select id="period" name="period" onchange="this.form.submit()">
          {% for option in period_options %}
          <option value="{{ option.key }}" {% if option.key == company.period.key %}selected{% endif %}>{{ option.label }}</option>
          {% endfor %}
        </select>
      </form>
    </div>
    <div class="metrics">
      <div class="metric" aria-label="Total balance">
        <span>Total Balance</span>
        <strong>{{ '{:,.2f}'.format(company.total_balance) }} EUR</strong>
      </div>
      <div class="metric" aria-label="Payroll headcount">
        <span>Payroll Headcount</span>
        <strong>{{ company.payroll_headcount }}</strong>
      </div>
      <div class="metric" aria-label="Active accounts">
        <span>Active Accounts</span>
        <strong>{{ company.accounts|length }}</strong>
      </div>
      <div class="metric" aria-label="Income for the selected period">
        <span>Income · {{ company.period.label }}</span>
        <strong>{{ '{:,.2f}'.format(company.income_total) }} EUR</strong>
      </div>
      <div class="metric" aria-label="Expenses for the selected period">
        <span>Expenses · {{ company.period.label }}</span>
        <strong>{{ '{:,.2f}'.format(company.expense_total) }} EUR</strong>
      </div>
      <div class="metric" aria-label="Net cash flow for the selected period">
        <span>Net Cash Flow</span>
        {% set net_class = 'positive' if company.net_cash_flow >= 0 else 'negative' %}
        <strong class="{{ net_class }}">{{ '{:,.2f}'.format(company.net_cash_flow) }} EUR</strong>
      </div>
      <div class="metric" aria-label="Payroll spend for the selected period">
        <span>Payroll Spend</span>
        <strong>{{ '{:,.2f}'.format(company.payroll_total) }} EUR</strong>
      </div>
    </div>
  </section>

  <section class="grid" aria-label="Company data">
    <article class="card" aria-labelledby="accounts-heading">
      <div class="card-header">
        <h3 id="accounts-heading">Accounts</h3>
        <span class="badge">{{ company.accounts|length }} total</span>
      </div>
      {% if company.accounts %}
      <table>
        <thead>
          <tr>
            <th scope="col">Name</th>
            <th scope="col">Type</th>
            <th scope="col">Balance</th>
          </tr>
        </thead>
        <tbody>
          {% for account in company.accounts %}
          <tr>
            <td>{{ account.name if account.name else 'Account #' ~ account.account_id }}</td>
            <td>{{ account.type|capitalize }}</td>
            <td>{{ '{:,.2f}'.format(account.balance) }} {{ account.currency }}</td>
          </tr>
          {% endfor %}
        </tbody>
      </table>
      {% else %}
      <p class="empty">No accounts are associated with this company.</p>
      {% endif %}
    </article>

    <article class="card" aria-labelledby="cashflow-heading">
      <div class="card-header">
        <h3 id="cashflow-heading">Cash Flow Snapshot</h3>
        <span class="badge">{{ company.period.label }}</span>
      </div>
      <table class="compact">
        <tbody>
          <tr>
            <th scope="row">Income</th>
            <td>{{ '{:,.2f}'.format(company.income_total) }} EUR</td>
          </tr>
          <tr>
            <th scope="row">Expenses</th>
            <td>{{ '{:,.2f}'.format(company.expense_total) }} EUR</td>
          </tr>
          <tr>
            <th scope="row">Net Cash Flow</th>
            {% set net_class = 'positive' if company.net_cash_flow >= 0 else 'negative' %}
            <td class="{{ net_class }}">{{ '{:,.2f}'.format(company.net_cash_flow) }} EUR</td>
          </tr>
        </tbody>
      </table>
    </article>

    <article class="card" aria-labelledby="payroll-heading">
      <div class="card-header">
        <h3 id="payroll-heading">Payroll</h3>
        <span class="badge">{{ '{:,.2f}'.format(company.payroll_total) }} EUR</span>
      </div>
      {% if company.payroll_employees %}
      <table class="compact">
        <thead>
          <tr>
            <th scope="col">Employee</th>
            <th scope="col">Compensation ({{ company.period.label }})</th>
          </tr>
        </thead>
        <tbody>
          {% for employee in company.payroll_employees %}
          <tr>
            <td>{{ employee.name }}</td>
            <td>{{ '{:,.2f}'.format(employee.total_compensation) }} EUR</td>
          </tr>
          {% endfor %}
        </tbody>
      </table>
      {% else %}
      <p class="empty">No payroll transactions matched the selected period.</p>
      {% endif %}
    </article>

    <article class="card" aria-labelledby="members-heading">
      <div class="card-header">
        <h3 id="members-heading">Members</h3>
        <span class="badge">{{ company.members|length }} total</span>
      </div>
      {% if company.members %}
      <table>
        <thead>
          <tr>
            <th scope="col">Name</th>
            <th scope="col">Role</th>
            <th scope="col">Email</th>
          </tr>
        </thead>
        <tbody>
          {% for member in company.members %}
          <tr>
            <td>{{ member.name }}</td>
            <td>{{ member.role|replace('_', ' ')|title }}</td>
            <td>{% if member.email %}<a href="mailto:{{ member.email }}">{{ member.email }}</a>{% else %}<span class="muted">Not provided</span>{% endif %}</td>
          </tr>
          {% endfor %}
        </tbody>
      </table>
      {% else %}
      <p class="empty">No members are associated with this company.</p>
      {% endif %}
    </article>

    <article class="card" aria-labelledby="expenses-heading">
      <div class="card-header">
        <h3 id="expenses-heading">Top Expense Categories</h3>
        <span class="badge">{{ company.period.label }}</span>
      </div>
      {% if company.top_expense_categories %}
      <table class="compact">
        <thead>
          <tr>
            <th scope="col">Category</th>
            <th scope="col">Spend</th>
          </tr>
        </thead>
        <tbody>
          {% for category in company.top_expense_categories %}
          <tr>
            <td>{{ category.name }}</td>
            <td>{{ '{:,.2f}'.format(category.total_spent) }} EUR</td>
          </tr>
          {% endfor %}
        </tbody>
      </table>
      {% else %}
      <p class="empty">No expense activity in the selected window.</p>
      {% endif %}
    </article>
  </section>
</section>
{% endblock %}
