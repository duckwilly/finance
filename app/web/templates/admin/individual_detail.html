{% extends "admin/base.html" %}

{% block title %}{{ individual.name }} · Finance Admin{% endblock %}

{% block head %}
<style>
  .layout {
    display: flex;
    flex-direction: column;
    gap: 1.75rem;
  }

  .breadcrumbs {
    display: inline-flex;
    align-items: center;
    gap: 0.5rem;
    font-size: 0.95rem;
  }

  .breadcrumbs a {
    color: var(--accent-color);
    text-decoration: none;
    font-weight: 600;
  }

  .breadcrumbs a:hover,
  .breadcrumbs a:focus {
    text-decoration: underline;
  }

  .overview {
    display: grid;
    gap: 1.5rem;
    padding: 1.75rem;
  }

  .overview-header {
    display: flex;
    flex-direction: column;
    gap: 0.75rem;
  }

  @media (min-width: 720px) {
    .overview-header {
      align-items: center;
      flex-direction: row;
      justify-content: space-between;
    }
  }

  .overview h2 {
    margin: 0;
    font-size: 1.6rem;
  }

  .period-meta {
    margin: 0.25rem 0 0;
    color: var(--muted-text);
    font-size: 0.9rem;
  }

  .period-form {
    display: flex;
    align-items: center;
    gap: 0.75rem;
    flex-wrap: wrap;
  }

  .period-form .field-group {
    display: inline-flex;
    align-items: center;
    gap: 0.5rem;
    flex-wrap: wrap;
  }

  .period-form label {
    font-size: 0.85rem;
    font-weight: 600;
    text-transform: uppercase;
    letter-spacing: 0.05em;
    color: var(--muted-text);
  }

  .period-form select,
  .period-form input[type="date"] {
    border-radius: 0.5rem;
    border: 1px solid rgba(148, 163, 184, 0.5);
    padding: 0.45rem 0.75rem;
    background-color: rgba(15, 23, 42, 0.03);
    font-size: 0.95rem;
    color: inherit;
  }

  .period-form span.separator {
    font-size: 0.85rem;
    color: var(--muted-text);
  }

  .period-form button {
    border: none;
    border-radius: 0.5rem;
    background-color: var(--accent-color);
    color: #ffffff;
    font-weight: 600;
    padding: 0.5rem 1.1rem;
    cursor: pointer;
  }

  .period-form button:hover,
  .period-form button:focus {
    background-color: #1d4ed8;
    outline: none;
  }

  .metrics {
    display: grid;
    grid-template-columns: repeat(auto-fit, minmax(180px, 1fr));
    gap: 1.25rem;
  }

  .metric {
    display: flex;
    flex-direction: column;
    gap: 0.35rem;
  }

  .metric span {
    font-size: 0.75rem;
    color: var(--muted-text);
    text-transform: uppercase;
    letter-spacing: 0.05em;
  }

  .metric strong {
    font-size: 1.3rem;
  }

  .metric strong.positive {
    color: #0f766e;
  }

  .metric strong.negative {
    color: #b91c1c;
  }

  .grid {
    display: grid;
    gap: 1.75rem;
  }

  @media (min-width: 960px) {
    .grid.two-column {
      grid-template-columns: 2fr 1fr;
    }

    .grid .wide {
      grid-column: 1 / -1;
    }
  }

  .card {
    padding: 1.25rem 0;
  }

  .card-body {
    padding: 0 1.25rem 1.25rem;
  }

  .card-header {
    display: flex;
    align-items: baseline;
    justify-content: space-between;
    gap: 1rem;
    padding: 0 1.25rem;
    margin-bottom: 0.5rem;
  }

  .card h3 {
    margin: 0;
    font-size: 1.2rem;
  }

  .badge {
    display: inline-flex;
    align-items: center;
    border-radius: 999px;
    padding: 0.3rem 0.75rem;
    font-size: 0.8rem;
    background: rgba(14, 116, 144, 0.12);
    color: #0f172a;
    font-weight: 600;
    letter-spacing: 0.03em;
  }

  table {
    width: 100%;
    border-collapse: collapse;
  }

  th,
  td {
    padding: 0.8rem 1rem;
    text-align: left;
    border-bottom: 1px solid rgba(100, 116, 139, 0.15);
  }

  th {
    font-size: 0.85rem;
    color: var(--muted-text);
    text-transform: uppercase;
    letter-spacing: 0.05em;
  }

  tbody tr:last-child td {
    border-bottom: none;
  }

  .compact {
    font-size: 0.95rem;
  }

  .muted {
    color: var(--muted-text);
  }

  .empty {
    padding: 1.25rem;
    color: var(--muted-text);
    font-style: italic;
  }

  .transaction-amount {
    font-weight: 600;
  }

  .transaction-amount.positive {
    color: #0f766e;
  }

  .transaction-amount.negative {
    color: #b91c1c;
  }

  .tag {
    display: inline-flex;
    padding: 0.2rem 0.6rem;
    border-radius: 999px;
    background: rgba(37, 99, 235, 0.12);
    color: var(--accent-color);
    font-size: 0.75rem;
    font-weight: 600;
  }
</style>
{% endblock %}

{% block content %}
<section class="layout">
  <nav class="breadcrumbs" aria-label="Breadcrumb">
    <a href="/admin/individuals">Individuals</a>
    <span aria-hidden="true">/</span>
    <span>{{ individual.name }}</span>
  </nav>

  <section class="overview card" aria-labelledby="individual-heading">
    <div class="overview-header">
      <div>
        <h2 id="individual-heading">{{ individual.name }}</h2>
        {% if individual.email %}
        <p class="muted" style="margin: 0;">{{ individual.email }}</p>
        {% endif %}
        <p class="period-meta">
          Reporting window:
          {{ individual.period.start.strftime('%b %d, %Y') }} –
          {{ individual.period.end.strftime('%b %d, %Y') }}
        </p>
      </div>
      <form method="get" class="period-form">
        <label for="period">Period</label>
        <select id="period" name="period">
          {% for option in period_options %}
          <option value="{{ option.key }}" {% if option.key == individual.period.key %}selected{% endif %}>
            {{ option.label }}
          </option>
          {% endfor %}
        </select>
        <span class="separator" aria-hidden="true">or</span>
        <div class="field-group">
          <input
            type="date"
            id="start-date"
            name="start_date"
            value="{{ individual.period.start.isoformat() }}"
          />
          <span class="separator" aria-hidden="true">to</span>
          <input
            type="date"
            id="end-date"
            name="end_date"
            value="{{ individual.period.end.isoformat() }}"
          />
        </div>
        <button type="submit">Apply</button>
      </form>
    </div>
    <div class="metrics">
      <div class="metric" aria-label="Net worth">
        <span>Net Worth</span>
        <strong>{{ '{:,.2f}'.format(individual.net_worth) }} EUR</strong>
      </div>
      <div class="metric" aria-label="Cash holdings">
        <span>Cash Accounts</span>
        <strong>{{ '{:,.2f}'.format(individual.cash_total) }} EUR</strong>
      </div>
      <div class="metric" aria-label="Investments">
        <span>Brokerage Holdings</span>
        <strong>{{ '{:,.2f}'.format(individual.holdings_total) }} EUR</strong>
      </div>
      <div class="metric" aria-label="Portfolio performance">
        <span>Portfolio P&amp;L · {{ individual.period.label }}</span>
        {% set portfolio_class = 'positive' if individual.portfolio_gain_loss >= 0 else 'negative' %}
        <strong class="{{ portfolio_class }}">
          {{ '{:,.2f}'.format(individual.portfolio_gain_loss) }} EUR
        </strong>
      </div>
      <div class="metric" aria-label="Income">
        <span>Income · {{ individual.period.label }}</span>
        <strong>{{ '{:,.2f}'.format(individual.income_total) }} EUR</strong>
      </div>
      <div class="metric" aria-label="Expenses">
        <span>Expenses · {{ individual.period.label }}</span>
        <strong>{{ '{:,.2f}'.format(individual.expense_total) }} EUR</strong>
      </div>
      <div class="metric" aria-label="Net cash flow">
        <span>Net Cash Flow</span>
        {% set net_class = 'positive' if individual.net_cash_flow >= 0 else 'negative' %}
        <strong class="{{ net_class }}">{{ '{:,.2f}'.format(individual.net_cash_flow) }} EUR</strong>
      </div>
    </div>
  </section>

  <section class="grid two-column">
    <article class="card">
      <div class="card-header">
        <h3>Accounts</h3>
        <span class="badge">{{ individual.accounts | length }} accounts</span>
      </div>
      {% if individual.accounts %}
      <div class="card-body" style="overflow-x: auto;">
        <table class="compact">
          <thead>
            <tr>
              <th scope="col">Account</th>
              <th scope="col">Type</th>
              <th scope="col">Balance</th>
            </tr>
          </thead>
          <tbody>
            {% for account in individual.accounts %}
            <tr>
              <td>{{ account.name or 'Unnamed account' }}</td>
              <td class="muted">{{ account.type|replace('_', ' ')|title }}</td>
              <td>{{ '{:,.2f}'.format(account.balance) }} {{ account.currency }}</td>
            </tr>
            {% endfor %}
          </tbody>
        </table>
      </div>
      {% else %}
      <p class="empty">No accounts available.</p>
      {% endif %}
    </article>

    <article class="card">
      <div class="card-header">
        <h3>Income Breakdown</h3>
      </div>
      {% if individual.income_breakdown %}
      <div class="card-body">
        <table class="compact">
          <thead>
            <tr>
              <th scope="col">Category</th>
              <th scope="col">Amount</th>
            </tr>
          </thead>
          <tbody>
            {% for category in individual.income_breakdown %}
            <tr>
              <td>{{ category.name }}</td>
              <td>{{ '{:,.2f}'.format(category.amount) }} EUR</td>
            </tr>
            {% endfor %}
          </tbody>
        </table>
      </div>
      {% else %}
      <p class="empty">No income activity in the selected window.</p>
      {% endif %}
    </article>

    <article class="card wide">
      <div class="card-header">
        <h3>Brokerage Holdings</h3>
        <span class="badge">{{ individual.holdings | length }} positions</span>
      </div>
      {% if individual.holdings %}
      <div class="card-body" style="overflow-x: auto;">
        <table class="compact">
          <thead>
            <tr>
              <th scope="col">Instrument</th>
              <th scope="col">Account</th>
              <th scope="col">Quantity</th>
              <th scope="col">Start Price</th>
              <th scope="col">End Price</th>
              <th scope="col">Change</th>
              <th scope="col">P&amp;L</th>
              <th scope="col">Market Value</th>
            </tr>
          </thead>
          <tbody>
            {% for holding in individual.holdings %}
            {% set change_class = 'positive' if holding.period_pl >= 0 else 'negative' %}
            <tr>
              <td>
                <div style="display: flex; flex-direction: column;">
                  <span>{{ holding.symbol }}</span>
                  <span class="muted">{{ holding.name }}</span>
                </div>
              </td>
              <td>{{ holding.account_name or 'Brokerage' }}</td>
              <td>{{ '{:,.4f}'.format(holding.quantity) }}</td>
              <td>
                {% if holding.start_price is not none %}
                {{ '{:,.2f}'.format(holding.start_price) }} {{ holding.currency }}
                {% else %}
                —
                {% endif %}
              </td>
              <td>{{ '{:,.2f}'.format(holding.end_price) }} {{ holding.currency }}</td>
              <td>
                {{ '{:+.2f}'.format(holding.price_change) }} {{ holding.currency }}
                {% if holding.price_change_pct is not none %}
                <span class="muted">({{ '{:+.2f}'.format(holding.price_change_pct) }}%)</span>
                {% endif %}
              </td>
              <td class="{{ change_class }}">
                {{ '{:+,.2f}'.format(holding.period_pl) }} {{ holding.currency }}
              </td>
              <td>{{ '{:,.2f}'.format(holding.market_value) }} {{ holding.currency }}</td>
            </tr>
            {% endfor %}
          </tbody>
        </table>
      </div>
      {% else %}
      <p class="empty">No brokerage holdings on record.</p>
      {% endif %}
    </article>

    <article class="card">
      <div class="card-header">
        <h3>Expense Breakdown</h3>
      </div>
      {% if individual.expense_breakdown %}
      <div class="card-body">
        <table class="compact">
          <thead>
            <tr>
              <th scope="col">Category</th>
              <th scope="col">Amount</th>
            </tr>
          </thead>
          <tbody>
            {% for category in individual.expense_breakdown %}
            <tr>
              <td>{{ category.name }}</td>
              <td>{{ '{:,.2f}'.format(category.amount) }} EUR</td>
            </tr>
            {% endfor %}
          </tbody>
        </table>
      </div>
      {% else %}
      <p class="empty">No expense activity in the selected window.</p>
      {% endif %}
    </article>
  </section>

  <section class="card">
    <div class="card-header">
      <h3>Recent Transactions</h3>
      <span class="badge">Last 20 entries</span>
    </div>
    {% if individual.recent_transactions %}
    <div class="card-body" style="overflow-x: auto;">
      <table class="compact">
        <thead>
          <tr>
            <th scope="col">Posted</th>
            <th scope="col">Account</th>
            <th scope="col">Description</th>
            <th scope="col">Counterparty</th>
            <th scope="col">Related</th>
            <th scope="col">Section</th>
            <th scope="col">Category</th>
            <th scope="col">Amount</th>
          </tr>
        </thead>
        <tbody>
          {% for txn in individual.recent_transactions %}
          {% set amount_class = 'positive' if txn.signed_amount >= 0 else 'negative' %}
          <tr>
            <td>
              <div style="display: flex; flex-direction: column;">
                <span>{{ txn.txn_date.strftime('%b %d, %Y') }}</span>
                <span class="muted">{{ txn.posted_at.strftime('%H:%M %Z') if txn.posted_at.tzinfo else txn.posted_at.strftime('%H:%M') }}</span>
              </div>
            </td>
            <td>{{ txn.account_name or 'Account' }}</td>
            <td>{{ txn.description or '—' }}</td>
            <td>
              {% if txn.counterparty %}
              {{ txn.counterparty.name or ('#' ~ txn.counterparty.counterparty_id) }}
              {% else %}
              —
              {% endif %}
            </td>
            <td>
              {% if txn.related_party %}
              {% if txn.related_party.type == 'company' %}
              <a class="tag" href="/admin/companies/{{ txn.related_party.party_id }}">
                {{ txn.related_party.name }}
              </a>
              {% else %}
              <a class="tag" href="/admin/individuals/{{ txn.related_party.party_id }}">
                {{ txn.related_party.name }}
              </a>
              {% endif %}
              {% else %}
              —
              {% endif %}
            </td>
            <td>{{ txn.section or '—' }}</td>
            <td>{{ txn.category or '—' }}</td>
            <td>
              <span class="transaction-amount {{ amount_class }}">
                {{ '{:,.2f}'.format(txn.signed_amount) }} {{ txn.currency }}
              </span>
            </td>
          </tr>
          {% endfor %}
        </tbody>
      </table>
    </div>
    {% else %}
    <p class="empty">No recent transactions available.</p>
    {% endif %}
  </section>
</section>
{% endblock %}
